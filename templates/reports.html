{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h1 style="margin-bottom: 2rem;">Business Reports</h1>

<div style="display: grid; gap: 30px;">

    <!-- Sales Analytics Chart -->
    <div class="glass-panel" style="padding: 20px;">
        <h2 style="margin-bottom: 20px;"><i class="fas fa-chart-area"></i> Sales Analytics (Last 7 Days)</h2>
        <canvas id="salesChart" data-labels='{{ chart_labels | tojson | safe }}'
            data-values='{{ chart_data | tojson | safe }}' style="max-height: 300px;"></canvas>
    </div>

    <!-- Low Stock Alert -->
    <div class="glass-panel" style="padding: 20px; border: 1px solid var(--danger-color);">
        <h2 style="margin-bottom: 20px; color: var(--danger-color);"><i class="fas fa-exclamation-circle"></i> Low Stock
            Alerts</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Current Stock</th>
                        <th>Supplier</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in low_stock %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>{{ item.category }}</td>
                        <td style="color: var(--danger-color); font-weight: bold;">{{ item.quantity }}</td>
                        <td>{{ item.supplier }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center;">All stock levels are healthy</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Sales Report -->
    <div class="glass-panel" style="padding: 20px;">
        <h2 style="margin-bottom: 20px;"><i class="fas fa-history"></i> Sales History</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Total Amount</th>
                        <th>Sold By</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr>
                        <td>{{ sale.date.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ sale.product_name }}</td>
                        <td>{{ sale.quantity }}</td>
                        <td>${{ "%.2f"|format(sale.total_price) }}</td>
                        <td>{{ sale.sold_by }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" style="text-align: center;">No sales records found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const canvas = document.getElementById('salesChart');
    if (canvas) {
        try {
            const labels = JSON.parse(canvas.dataset.labels || '[]');
            const values = JSON.parse(canvas.dataset.values || '[]');

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue ($)',
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#3b82f6',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        } catch (e) {
            console.error('Error parsing chart data:', e);
        }
    }
</script>
{% endblock %}