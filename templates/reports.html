{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h1 style="margin-bottom: 2rem;">Business Reports</h1>

<div class="export-buttons" style="margin-bottom: 2rem; display: flex; gap: 10px; flex-wrap: wrap;">
    <a href="{{ url_for('export_products_csv') }}" class="btn btn-primary" title="Export products as CSV">
        <i class="fas fa-download"></i> Export Products
    </a>
    <a href="{{ url_for('export_sales_csv') }}" class="btn btn-primary" title="Export sales as CSV">
        <i class="fas fa-download"></i> Export Sales
    </a>
    <a href="{{ url_for('export_returns_csv') }}" class="btn btn-primary" title="Export returns as CSV">
        <i class="fas fa-download"></i> Export Returns
    </a>
    <a href="{{ url_for('export_low_stock_csv') }}" class="btn btn-danger" title="Export low stock alerts as CSV">
        <i class="fas fa-download"></i> Export Low Stock
    </a>
</div>

<div style="display: grid; gap: 30px;">

    <!-- Sales Analytics Chart -->
    <div class="glass-panel" style="padding: 20px;">
        <h2 style="margin-bottom: 20px;"><i class="fas fa-chart-area"></i> Sales Analytics (Last 7 Days)</h2>
        <canvas id="salesChart" data-labels='{{ chart_labels | tojson | safe }}'
            data-values='{{ chart_data | tojson | safe }}' style="max-height: 300px;"></canvas>
    </div>

    <!-- Low Stock Alert -->
    <div class="glass-panel" style="padding: 20px; border: 1px solid var(--danger-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: var(--danger-color);"><i class="fas fa-exclamation-circle"></i> Low Stock Alerts</h2>
            <span
                style="background: var(--danger-color); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">
                {{ low_stock|length }} Items
            </span>
        </div>
        <div class="table-container">
            <table id="low-stock-table">
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Current Stock</th>
                        <th>Supplier</th>
                        <th>Alert Level</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in low_stock %}
                    <tr class="{% if item.quantity == 0 %}out-of-stock{% endif %}">
                        <td><strong>{{ item.name }}</strong></td>
                        <td>{{ item.category }}</td>
                        <td>{{ item.quantity }} units</td>
                        <td>{{ item.supplier }}</td>
                        <td>
                            {% if item.quantity == 0 %}
                            <span
                                style="background: var(--danger-color); color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.85rem;">Out
                                of Stock</span>
                            {% else %}
                            <span
                                style="background: var(--warning-color); color: black; padding: 3px 8px; border-radius: 5px; font-size: 0.85rem;">Low
                                Stock</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px;">âœ“ All items have sufficient stock
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Sales Report -->
    <div class="glass-panel" style="padding: 20px;">
        <h2 style="margin-bottom: 20px;"><i class="fas fa-shopping-cart"></i> Recent Sales</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Customer</th>
                        <th>Quantity</th>
                        <th>Total Price</th>
                        <th>Date</th>
                        <th>Sold By</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr>
                        <td><strong>{{ sale.product_name }}</strong></td>
                        <td>{{ sale.customer_name }}</td>
                        <td>{{ sale.quantity }}</td>
                        <td>${{ "%.2f"|format(sale.total_price) }}</td>
                        <td>{{ sale.date.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ sale.sold_by }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center;">No sales data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Returns Report -->
    <div class="glass-panel" style="padding: 20px;">
        <h2 style="margin-bottom: 20px;"><i class="fas fa-undo"></i> Returns Log</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Reason</th>
                        <th>Supplier</th>
                        <th>Date</th>
                        <th>Processed By</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ret in returns %}
                    <tr>
                        <td><strong>{{ ret.product_name }}</strong></td>
                        <td>{{ ret.quantity }}</td>
                        <td>{{ ret.reason }}</td>
                        <td>{{ ret.supplier_name }}</td>
                        <td>{{ ret.date.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ ret.processed_by }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center;">No returns recorded</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

.out-of-stock {
background: rgba(239, 68, 68, 0.1);
}
</style>
{% endblock %}

{% block scripts %}
<!-- Chart rendering is handled by platform.js -->
{% endblock %}